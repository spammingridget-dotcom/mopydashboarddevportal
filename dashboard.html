<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mopy Dashboard</title>

<style>
    body {
        margin: 0;
        height: 100vh;
        font-family: "Inter", sans-serif;
        background: radial-gradient(circle at 50% 20%, #081122, #000000 80%);
        color: white;
        overflow: hidden;
    }

    .stars {
        position: absolute;
        width: 2px;
        height: 2px;
        background: white;
        border-radius: 50%;
        animation: fall 8s linear infinite;
        opacity: 0.8;
    }

    @keyframes fall {
        from { transform: translateY(-10vh); }
        to { transform: translateY(110vh); }
    }

    .container {
        position: relative;
        width: 90%;
        max-width: 900px;
        margin: 40px auto;
        background: rgba(255,255,255,0.07);
        border-radius: 18px;
        padding: 30px;
        backdrop-filter: blur(10px);
        box-shadow: 0 0 40px rgba(0,0,0,0.7);
        overflow-y: auto;
        max-height: 90vh;
    }

    h2 {
        margin-top: 0;
        font-size: 2rem;
        text-shadow: 0 0 20px rgba(255,255,255,0.3);
    }

    .task {
        padding: 15px;
        background: rgba(255,255,255,0.08);
        border-radius: 14px;
        margin-top: 15px;
        backdrop-filter: blur(5px);
    }

    .btn {
        padding: 10px 18px;
        border: none;
        background: #1e66ff;
        color: white;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 10px;
        transition: .2s;
    }
    .btn:hover {
        background: #4c82ff;
        box-shadow: 0 0 20px rgba(76,130,255,0.6);
    }

    select, input {
        width: 100%;
        padding: 10px;
        margin-top: 8px;
        border-radius: 10px;
        border: none;
        outline: none;
    }

    .logout {
        float: right;
        text-decoration: none;
        padding: 8px 14px;
        background: #b83535;
        border-radius: 10px;
        color: white;
        font-weight: 600;
    }
</style>
</head>

<body>

<script>
// star background
function stars(n){
    for(let i=0;i<n;i++){
        let s=document.createElement("div");
        s.className="stars";
        s.style.left=Math.random()*100+"vw";
        s.style.top=Math.random()*100+"vh";
        s.style.opacity=Math.random();
        document.body.appendChild(s);
    }
}
stars(140);

const currentUser = localStorage.getItem("user");
if(!currentUser) window.location.href="login.html";

let users = ["mopy","astral_void","Etern","CX","St3amyEggroll"];
let tasks = JSON.parse(localStorage.getItem("tasks") || "[]");

function save(){
    localStorage.setItem("tasks", JSON.stringify(tasks));
    render(); // <-- IMPORTANT FIX
}

function createTask(){
    let title = document.getElementById("title").value.trim();
    let assigned = [...document.getElementById("assigned").selectedOptions].map(o => o.value);

    if(!title || assigned.length === 0) return;

    // weekly limit for normal users
    if(currentUser !== "mopy"){
        let limit = tasks.filter(t => t.creator === currentUser).length;
        if(limit >= 3){
            alert("You reached 3 tasks per week.");
            return;
        }
    }

    tasks.push({
        id: Date.now(),
        title,
        creator: currentUser,
        assigned,
        completedBy: []
    });

    document.getElementById("title").value = "";
    document.getElementById("assigned").selectedIndex = -1;

    save(); // <--- FIX (triggers render)
}

function finishTask(id){
    let t = tasks.find(x => x.id === id);

    if(!t.completedBy.includes(currentUser)){
        t.completedBy.push(currentUser);
    }

    // complete only when ALL assigned finished
    if(t.completedBy.length === t.assigned.length){
        tasks = tasks.filter(x => x.id !== id);
    }

    save();
}

function render(){
    let box = document.getElementById("tasks");
    box.innerHTML = "";

    tasks.forEach(t => {
        let done = t.completedBy.length;
        let total = t.assigned.length;

        let div = document.createElement("div");
        div.className = "task";

        div.innerHTML = `
            <strong>${t.title}</strong><br>
            Assigned: ${t.assigned.join(", ")}<br>
            Progress: ${done}/${total}<br>
        `;

        if(t.assigned.includes(currentUser)){
            if(!t.completedBy.includes(currentUser)){
                let b = document.createElement("button");
                b.className = "btn";
                b.textContent = "Finish Task";
                b.onclick = () => finishTask(t.id);
                div.appendChild(b);
            }
        }

        box.appendChild(div);
    });
}
</script>

<div class="container">
    <a class="logout" href="login.html" onclick="localStorage.removeItem('user')">Logout</a>
    <h2>Welcome, <span id="userDisplay"></span></h2>

    <script>
        document.getElementById("userDisplay").textContent = currentUser;
    </script>

    <h3>Create Task</h3>

    <input id="title" placeholder="Task title">

    <select id="assigned" multiple size="5">
        <script>
            users.forEach(u => {
                document.write(`<option value="${u}">${u}</option>`);
            });
        </script>
    </select>

    <button class="btn" onclick="createTask()">Create Task</button>

    <h3 style="margin-top: 30px;">Tasks</h3>
    <div id="tasks"></div>

</div>

<script>render()</script>

</body>
</html>
