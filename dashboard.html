<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Mopy Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  margin:0;
  background: radial-gradient(circle at 20% 20%, #101531, #04050b 80%);
  font-family: Inter, Arial, sans-serif;
  color:white;
  min-height:100vh;
  padding:40px;
}

/* Jupiter */
.planet {
  width:180px;
  height:180px;
  border-radius:50%;
  background:radial-gradient(circle at 30% 30%, #ff9f6b, #b45a27);
  position:absolute;
  right:40px;
  top:40px;
  animation: float 4s ease-in-out infinite;
}
.planet::after {
  content:"";
  position:absolute;
  width:260px;
  height:80px;
  border-radius:50%;
  background:rgba(255,200,160,0.25);
  top:60px;
  left:-40px;
  transform:rotate(-18deg);
  filter:blur(2px);
}
@keyframes float {
  0%{ transform:translateY(0); }
  50%{ transform:translateY(-12px); }
  100%{ transform:translateY(0); }
}

h1 { margin-bottom:10px; }
#userRole { opacity:0.7; margin-bottom:30px; }

.panel {
  background:rgba(255,255,255,0.06);
  padding:20px;
  border-radius:12px;
  margin-bottom:30px;
  backdrop-filter:blur(6px);
}

input, select {
  padding:10px;
  border:none;
  border-radius:8px;
  width:100%;
  background:rgba(255,255,255,0.05);
  color:white;
  margin-top:10px;
}

button {
  padding:12px 20px;
  border:none;
  border-radius:10px;
  margin-top:14px;
  background:linear-gradient(180deg,#4f8cff,#1e66ff);
  color:white;
  cursor:pointer;
  font-weight:600;
}

.task {
  background:rgba(255,255,255,0.05);
  padding:14px;
  border-radius:10px;
  margin-top:12px;
}
.assigned { opacity:0.8; font-size:0.9rem; }
.finishBtn {
  margin-top:8px;
  padding:8px 14px;
  font-size:0.9rem;
}
</style>
</head>

<body>

<div class="planet"></div>

<h1>Mopy Dev Dashboard</h1>
<div id="userRole"></div>

<!-- CREATE TASK PANEL -->
<div class="panel" id="createPanel" style="display:none;">
  <h2>Create a Task</h2>
  <input id="taskTitle" placeholder="Task title" />

  <label style="opacity:0.8;">Assign to developers:</label>
  <select id="assignList" multiple size="6">
    <option>mopy</option>
    <option>astral_void</option>
    <option>Etern</option>
    <option>CX</option>
    <option>St3amyEggroll</option>
    <option>Keagan</option>
  </select>

  <button onclick="createTask()">Create Task</button>
  <div id="createErr" style="color:#ff6f6f;margin-top:10px;"></div>
</div>

<!-- TASK LIST -->
<div class="panel">
  <h2>Tasks</h2>
  <div id="taskList">Loading…</div>
</div>

<script>
const supabase = supabase.createClient(
  "https://lzsopkzlifwjdhtxtrkt.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx6c29wa3psaWZ3amRodHh0cmt0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjIzNzMsImV4cCI6MjA3OTM5ODM3M30.owsfr2JR_a5DH76TMvh1JX4atPGznmZz1ikQ60nwT8k"
);

// Load user
const USER = localStorage.getItem("dev_user");
const ROLE = localStorage.getItem("dev_role");

if (!USER) location.href = "login.html";

document.getElementById("userRole").textContent =
  "Logged in as: " + USER + " (" + ROLE + ")";

if (ROLE === "owner" || ROLE === "editor") {
  document.getElementById("createPanel").style.display = "block";
}

async function loadTasks() {
  const { data } = await supabase.from("tasks").select("*");

  const box = document.getElementById("taskList");
  box.innerHTML = "";

  data.forEach(t => {
    const div = document.createElement("div");
    div.className = "task";

    const assigned = JSON.parse(t.assigned_to || "[]");
    const finished = JSON.parse(t.finished_by || "[]");

    const allDone = finished.length >= assigned.length;

    div.innerHTML = `
      <b>${t.title}</b><br>
      <div class="assigned">Assigned to: ${assigned.join(", ")}</div>
      <div>Status: ${allDone ? "✅ Completed" : finished.length + "/" + assigned.length}</div>
    `;

    // Can finish?
    if (
      assigned.includes(USER) &&
      !finished.includes(USER) &&
      ROLE !== "viewer"
    ) {
      const b = document.createElement("button");
      b.textContent = "Mark Finished";
      b.className = "finishBtn";
      b.onclick = () => finishTask(t.id, finished);
      div.appendChild(b);
    }

    box.appendChild(div);
  });
}

async function finishTask(id, finishedList) {
  finishedList.push(USER);
  await supabase.from("tasks").update({
    finished_by: JSON.stringify(finishedList)
  }).eq("id", id);

  loadTasks();
}

async function createTask() {
  const title = document.getElementById("taskTitle").value.trim();
  const assignedOptions = [...document.getElementById("assignList").selectedOptions].map(o => o.value);
  const err = document.getElementById("createErr");

  if (!title) return err.textContent = "Title is required.";
  if (assignedOptions.length === 0) return err.textContent = "Assign at least one developer.";

  if (ROLE === "viewer") return err.textContent="Viewers cannot create tasks.";

  if (ROLE === "editor") {
    const weekStart = new Date(); weekStart.setDate(weekStart.getDate() - weekStart.getDay());
    const { data } = await supabase.from("tasks")
      .select("*")
      .eq("creator", USER);

    const count = data.filter(t => new Date(t.created_at) >= weekStart).length;
    if (count >= 3) return err.textContent = "You already created 3 tasks this week.";
  }

  await supabase.from("tasks").insert({
    title,
    assigned_to: JSON.stringify(assignedOptions),
    finished_by: "[]",
    creator: USER
  });

  err.textContent = "";
  taskTitle.value = "";
  loadTasks();
}

loadTasks();

// Live update
supabase.channel("tasks").on("postgres_changes", { event: "*", schema:"public", table:"tasks" }, loadTasks).subscribe();
</script>

</body>
</html>
